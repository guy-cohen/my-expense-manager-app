<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×”×•×¦××•×ª - × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="theme-toggle" title="×”×—×œ×£ ×¢×¨×›×ª × ×•×©×">
        <span class="theme-icon">ğŸŒ™</span>
    </button>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ’° ×× ×”×œ ×”×•×¦××•×ª</h1>
            <p>× ×”×œ ××ª ×”×›×¡×¤×™× ×©×œ×š ×‘×¦×•×¨×” ×—×›××” ×•×™×¢×™×œ×”</p>
        </div>

        <!-- Dashboard Cards -->
        <div class="dashboard">
            <div class="card income">
                <div class="icon">ğŸ“ˆ</div>
                <h2>×¡×š ×”×›× ×¡×•×ª</h2>
                <div class="amount">{{ "{:,.0f}".format(total_income) }} â‚ª</div>
            </div>
            <div class="card expense">
                <div class="icon">ğŸ“‰</div>
                <h2>×¡×š ×”×•×¦××•×ª</h2>
                <div class="amount">{{ "{:,.0f}".format(total_expenses) }} â‚ª</div>
            </div>
            <div class="card balance {% if balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                <div class="icon">ğŸ’</div>
                <h2>×™×ª×¨×”</h2>
                <div class="amount">{{ "{:,.0f}".format(balance) }} â‚ª</div>
            </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="form-section">
            <h2>â• ×”×•×¡×£ ×ª× ×•×¢×” ×—×“×©×”</h2>
            <form action="/add" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="type">×¡×•×’ ×ª× ×•×¢×”:</label>
                        <select name="type" id="type" required>
                            <option value="Income">×”×›× ×¡×”</option>
                            <option value="Expense">×”×•×¦××”</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">×§×˜×’×•×¨×™×”:</label>
                        <div class="searchable-select-wrapper">
                            <input type="text" id="category-search" class="category-search-input" placeholder="×—×¤×© ××• ×‘×—×¨ ×§×˜×’×•×¨×™×”..." autocomplete="off">
                            <input type="hidden" name="category" id="category" required>
                            <div class="category-dropdown" id="category-dropdown">
                                <!-- Options will be populated dynamically by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">×¡×›×•× (â‚ª):</label>
                        <input type="number" name="amount" id="amount" step="0.01" required placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="date">×ª××¨×™×š:</label>
                        <input type="date" name="date" id="date" required>
                    </div>
                </div>
                
                <button type="submit">×”×•×¡×£ ×ª× ×•×¢×”</button>
            </form>
        </div>

        <!-- Transactions Table -->
        <div class="transactions-section">
            <h2>ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×ª× ×•×¢×•×ª</h2>
            
            <!-- Filter Section -->
            <div class="filter-section" id="filter-section">
                <div class="form-group">
                    <label for="filter-search">ğŸ” ×—×™×¤×•×©:</label>
                    <input type="text" id="filter-search" placeholder="×—×¤×© ×œ×¤×™ ×§×˜×’×•×¨×™×” ××• ×¡×›×•×...">
                </div>
                <div class="form-group">
                    <label for="filter-type">×¡×•×’:</label>
                    <select id="filter-type">
                        <option value="">×”×›×œ</option>
                        <option value="Income">×”×›× ×¡×•×ª</option>
                        <option value="Expense">×”×•×¦××•×ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-period">×ª×§×•×¤×”:</label>
                    <select id="filter-period">
                        <option value="">×”×›×œ</option>
                        <option value="month">×—×•×“×© × ×•×›×—×™</option>
                        <option value="year">×©× ×” × ×•×›×—×™×ª</option>
                        <option value="custom-month">×‘×—×¨ ×—×•×“×©</option>
                        <option value="custom-year">×‘×—×¨ ×©× ×”</option>
                    </select>
                </div>
                <div class="form-group" id="custom-month-group" style="display: none;">
                    <label for="filter-custom-month">×‘×—×¨ ×—×•×“×©:</label>
                    <select id="filter-custom-month">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group" id="custom-year-group" style="display: none;">
                    <label for="filter-custom-year">×‘×—×¨ ×©× ×”:</label>
                    <select id="filter-custom-year">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group filter-buttons">
                    <button type="button" class="btn-filter" id="apply-filter">ğŸ” ×¡× ×Ÿ</button>
                    <button type="button" class="btn-clear-filter" id="clear-filter">âœ– × ×§×”</button>
                </div>
            </div>
            
            {% if transactions %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>×¤×¢×•×œ×•×ª</th>
                            <th class="sortable" data-column="date">×ª××¨×™×š <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" data-column="amount">×¡×›×•× <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" data-column="category">×§×˜×’×•×¨×™×” <span class="sort-icon">â‡…</span></th>
                            <th class="sortable" data-column="type">×¡×•×’ <span class="sort-icon">â‡…</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr class="transaction-{{ 'income' if transaction[1] == 'Income' else 'expense' }}" data-id="{{ transaction[0] }}">
                            <td class="actions-cell">
                                <button type="button" class="edit-btn" onclick="openEditModal({{ transaction[0] }})">âœï¸ ×¢×¨×•×š</button>
                                <a href="/delete/{{ transaction[0] }}" class="delete-btn" onclick="return confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×ª× ×•×¢×” ×–×•?')">ğŸ—‘ï¸ ××—×§</a>
                            </td>
                            <td data-date="{{ transaction[4] }}">{{ transaction[4] }}</td>
                            <td class="amount-{{ 'income' if transaction[1] == 'Income' else 'expense' }}" data-amount="{{ transaction[3] }}">
                                {{ "{:,.2f}".format(transaction[3]) }} â‚ª
                            </td>
                            <td data-category="{{ transaction[2] }}">{{ transaction[2] }}</td>
                            <td data-type="{{ transaction[1] }}">
                                {% if transaction[1] == 'Income' %}
                                    <span style="color: #10b981; font-weight: 600;">ğŸ“ˆ ×”×›× ×¡×”</span>
                                {% else %}
                                    <span style="color: #ef4444; font-weight: 600;">ğŸ“‰ ×”×•×¦××”</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="balance-row">
                            <td colspan="2" style="text-align: left; font-weight: bold; font-size: 1.1rem;">×™×ª×¨×”:</td>
                            <td class="balance-amount {% if balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}" style="font-weight: bold; font-size: 1.2rem;">
                                {{ "{:,.2f}".format(balance) }} â‚ª
                            </td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <form action="/export" method="POST" id="export-form" style="margin-top: 20px;">
                <input type="hidden" name="sort_column" id="export-sort-column" value="date">
                <input type="hidden" name="sort_direction" id="export-sort-direction" value="desc">
                <button type="submit" class="btn-export">ğŸ“¥ ×™×™×¦× ×œ×§×•×‘×¥ CSV</button>
            </form>
            {% else %}
            <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>××™×Ÿ ×ª× ×•×¢×•×ª ×¢×“×™×™×Ÿ. ×”×ª×—×œ ×œ×”×•×¡×™×£ ×ª× ×•×¢×•×ª ×›×“×™ ×œ×¢×§×•×‘ ××—×¨ ×”×”×•×¦××•×ª ×•×”×”×›× ×¡×•×ª ×©×œ×š!</p>
            </div>
            {% endif %}
        </div>

        <!-- Charts -->
        {% if transactions %}
        <div class="charts-section">
            <div class="chart-container">
                <h2>ğŸ“Š ×¡×™×›×•× ×”×›× ×¡×•×ª ××•×œ ×”×•×¦××•×ª</h2>
                <canvas id="incomeExpenseChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h2>ğŸ¥§ ×¤×™×œ×•×— ×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª</h2>
                <canvas id="expensePieChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();

        // Global chart instances for updating
        var incomeExpenseChart = null;
        var expensePieChart = null;

        // Chart colors for pie chart
        var pieChartColors = [
            '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6',
            '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16',
            '#a855f7', '#f43f5e', '#22c55e', '#eab308', '#6366f1',
            '#d946ef', '#0ea5e9', '#65a30d', '#c026d3', '#fb7185',
            '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#f472b6'
        ];

        {% if transactions %}
        // Income vs Expense Bar Chart
        var ctx = document.getElementById('incomeExpenseChart').getContext('2d');
        incomeExpenseChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['×”×›× ×¡×•×ª', '×”×•×¦××•×ª'],
                datasets: [{
                    label: '×¡×›×•× (â‚ª)',
                    data: [{{ total_income }}, {{ total_expenses }}],
                    backgroundColor: [
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(239, 68, 68, 0.8)'
                    ],
                    borderColor: [
                        'rgba(16, 185, 129, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            borderColor: 'rgba(148, 163, 184, 0.2)'
                        },
                        ticks: {
                            color: '#cbd5e1',
                            callback: function(value) {
                                return 'â‚ª' + value.toLocaleString('he-IL');
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(148, 163, 184, 0.1)',
                            borderColor: 'rgba(148, 163, 184, 0.2)'
                        },
                        ticks: {
                            color: '#cbd5e1'
                        }
                    }
                }
            }
        });

        // Expense Breakdown Pie Chart - Build initial data from transactions
        var expenseCategories = [];
        var expenseAmounts = [];
        var categoryTotals = {};

        // Calculate category totals from transactions
        {% for transaction in transactions %}
            {% if transaction[1] == 'Expense' %}
                var cat = "{{ transaction[2] }}";
                var amt = {{ transaction[3] }};
                if (categoryTotals[cat]) {
                    categoryTotals[cat] += amt;
                } else {
                    categoryTotals[cat] = amt;
                }
            {% endif %}
        {% endfor %}

        // Convert to arrays for chart
        for (var cat in categoryTotals) {
            if (categoryTotals[cat] > 0) {
                expenseCategories.push(cat);
                expenseAmounts.push(categoryTotals[cat]);
            }
        }

        var pieCtx = document.getElementById('expensePieChart').getContext('2d');
        expensePieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: expenseCategories,
                datasets: [{
                    label: '×”×•×¦××•×ª',
                    data: expenseAmounts,
                    backgroundColor: pieChartColors.slice(0, expenseCategories.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        rtl: true,
                        labels: {
                            padding: 15,
                            color: '#cbd5e1',
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#e2e8f0',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(129, 140, 248, 0.3)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed || 0;
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': â‚ª' + value.toLocaleString('he-IL') + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
        {% endif %}

        // Function to update charts with filtered data
        function updateCharts(data) {
            // Update Income vs Expense Bar Chart
            if (incomeExpenseChart) {
                incomeExpenseChart.data.datasets[0].data = [data.total_income, data.total_expenses];
                incomeExpenseChart.update();
            }

            // Update Expense Pie Chart
            if (expensePieChart && data.category_breakdown) {
                var categories = data.category_breakdown.map(item => item.category);
                var amounts = data.category_breakdown.map(item => item.total);
                
                expensePieChart.data.labels = categories;
                expensePieChart.data.datasets[0].data = amounts;
                expensePieChart.data.datasets[0].backgroundColor = pieChartColors.slice(0, categories.length);
                expensePieChart.update();
            }
        }

        // Make updateCharts available globally
        window.updateCharts = updateCharts;
    </script>

    <!-- Edit Transaction Modal -->
    <div class="modal-overlay" id="edit-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2>âœï¸ ×¢×¨×™×›×ª ×ª× ×•×¢×”</h2>
                <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="edit-type">×¡×•×’ ×ª× ×•×¢×”:</label>
                        <select name="type" id="edit-type" required>
                            <option value="Income">×”×›× ×¡×”</option>
                            <option value="Expense">×”×•×¦××”</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-category">×§×˜×’×•×¨×™×”:</label>
                        <div class="searchable-select-wrapper">
                            <input type="text" id="edit-category-search" class="category-search-input" placeholder="×—×¤×© ××• ×‘×—×¨ ×§×˜×’×•×¨×™×”..." autocomplete="off">
                            <input type="hidden" name="category" id="edit-category" required>
                            <div class="category-dropdown" id="edit-category-dropdown">
                                <!-- Options will be populated dynamically by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-amount">×¡×›×•× (â‚ª):</label>
                        <input type="number" name="amount" id="edit-amount" step="0.01" required placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-date">×ª××¨×™×š:</label>
                        <input type="date" name="date" id="edit-date" required>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
